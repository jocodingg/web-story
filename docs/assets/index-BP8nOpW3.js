var O=t=>{throw TypeError(t)};var k=(t,e,n)=>e.has(t)||O("Cannot "+n);var c=(t,e,n)=>(k(t,e,"read from private field"),n?n.call(t):e.get(t)),f=(t,e,n)=>e.has(t)?O("Cannot add the same private member more than once"):e instanceof WeakSet?e.add(t):e.set(t,n),w=(t,e,n,r)=>(k(t,e,"write to private field"),r?r.call(t,n):e.set(t,n),n),R=(t,e,n)=>(k(t,e,"access private method"),n);(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))r(i);new MutationObserver(i=>{for(const s of i)if(s.type==="childList")for(const a of s.addedNodes)a.tagName==="LINK"&&a.rel==="modulepreload"&&r(a)}).observe(document,{childList:!0,subtree:!0});function n(i){const s={};return i.integrity&&(s.integrity=i.integrity),i.referrerPolicy&&(s.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?s.credentials="include":i.crossOrigin==="anonymous"?s.credentials="omit":s.credentials="same-origin",s}function r(i){if(i.ep)return;i.ep=!0;const s=n(i);fetch(i.href,s)}})();class W{constructor(){this.listContainer=null,this.mapContainer=null}getTemplate(){return`
      <section class="home-container">
        <h1>Daftar Cerita</h1>
        <div id="story-list" class="story-list"></div>
        <div id="map" style="height: 400px; margin-top: 2rem;"></div>
      </section>
    `}init(){this.listContainer=document.getElementById("story-list"),this.mapContainer=document.getElementById("map")}renderStories(e){this.listContainer.innerHTML=e.map(n=>`
      <div id="story-${n.id}" class="story-card" style="border: 1px solid #ccc; padding: 10px; margin: 10px 0;">
        <img src="${n.photoUrl}" alt="${n.name}" width="200" />
        <p><strong>${n.name}</strong></p>
        <p>${n.description}</p>
        <p>${new Date(n.createdAt).toLocaleString()}</p>
        <button class="bookmark-btn">Simpan</button>
      </div>
    `).join("")}renderMap(e){const n=L.map(this.mapContainer).setView([-2.5,117.5],4);L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{attribution:"Â© OpenStreetMap contributors"}).addTo(n),e.forEach(r=>{r.lat&&r.lon&&L.marker([r.lat,r.lon]).addTo(n).bindPopup(`<strong>${r.name}</strong><br>${r.description}`)})}showError(e){this.listContainer.innerHTML=`<p>Error: ${e.message}</p>`}}const E={BASE_URL:"https://story-api.dicoding.dev/v1"},J=async(t,e,n)=>{const r=await fetch(`${E.BASE_URL}/register`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({name:t,email:e,password:n})}),i=await r.json();if(!r.ok)throw new Error(i.message);return i},z=async(t,e)=>{const n=await fetch(`${E.BASE_URL}/login`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({email:t,password:e})}),r=await n.json();if(!n.ok)throw new Error(r.message);return localStorage.setItem("token",`Bearer ${r.loginResult.token}`),r},G=async()=>{const t=await fetch(`${E.BASE_URL}/stories`,{method:"GET",headers:{Authorization:localStorage.getItem("token")}}),e=await t.json();if(!t.ok)throw new Error(e.message);return e.listStory},Y=async({description:t,photo:e,lat:n,lon:r})=>{const i=new FormData;i.append("description",t),i.append("photo",e),n&&i.append("lat",n),r&&i.append("lon",r);const s=await fetch(`${E.BASE_URL}/stories`,{method:"POST",headers:{Authorization:localStorage.getItem("token")},body:i}),a=await s.json();if(!s.ok)throw new Error(a.message);return a},C=(t,e)=>e.some(n=>t instanceof n);let H,j;function Q(){return H||(H=[IDBDatabase,IDBObjectStore,IDBIndex,IDBCursor,IDBTransaction])}function X(){return j||(j=[IDBCursor.prototype.advance,IDBCursor.prototype.continue,IDBCursor.prototype.continuePrimaryKey])}const T=new WeakMap,S=new WeakMap,B=new WeakMap;function Z(t){const e=new Promise((n,r)=>{const i=()=>{t.removeEventListener("success",s),t.removeEventListener("error",a)},s=()=>{n(u(t.result)),i()},a=()=>{r(t.error),i()};t.addEventListener("success",s),t.addEventListener("error",a)});return B.set(e,t),e}function ee(t){if(T.has(t))return;const e=new Promise((n,r)=>{const i=()=>{t.removeEventListener("complete",s),t.removeEventListener("error",a),t.removeEventListener("abort",a)},s=()=>{n(),i()},a=()=>{r(t.error||new DOMException("AbortError","AbortError")),i()};t.addEventListener("complete",s),t.addEventListener("error",a),t.addEventListener("abort",a)});T.set(t,e)}let M={get(t,e,n){if(t instanceof IDBTransaction){if(e==="done")return T.get(t);if(e==="store")return n.objectStoreNames[1]?void 0:n.objectStore(n.objectStoreNames[0])}return u(t[e])},set(t,e,n){return t[e]=n,!0},has(t,e){return t instanceof IDBTransaction&&(e==="done"||e==="store")?!0:e in t}};function _(t){M=t(M)}function te(t){return X().includes(t)?function(...e){return t.apply(x(this),e),u(this.request)}:function(...e){return u(t.apply(x(this),e))}}function ne(t){return typeof t=="function"?te(t):(t instanceof IDBTransaction&&ee(t),C(t,Q())?new Proxy(t,M):t)}function u(t){if(t instanceof IDBRequest)return Z(t);if(S.has(t))return S.get(t);const e=ne(t);return e!==t&&(S.set(t,e),B.set(e,t)),e}const x=t=>B.get(t);function re(t,e,{blocked:n,upgrade:r,blocking:i,terminated:s}={}){const a=indexedDB.open(t,e),y=u(a);return r&&a.addEventListener("upgradeneeded",o=>{r(u(a.result),o.oldVersion,o.newVersion,u(a.transaction),o)}),n&&a.addEventListener("blocked",o=>n(o.oldVersion,o.newVersion,o)),y.then(o=>{s&&o.addEventListener("close",()=>s()),i&&o.addEventListener("versionchange",d=>i(d.oldVersion,d.newVersion,d))}).catch(()=>{}),y}const ie=["get","getKey","getAll","getAllKeys","count"],se=["put","add","delete","clear"],I=new Map;function $(t,e){if(!(t instanceof IDBDatabase&&!(e in t)&&typeof e=="string"))return;if(I.get(e))return I.get(e);const n=e.replace(/FromIndex$/,""),r=e!==n,i=se.includes(n);if(!(n in(r?IDBIndex:IDBObjectStore).prototype)||!(i||ie.includes(n)))return;const s=async function(a,...y){const o=this.transaction(a,i?"readwrite":"readonly");let d=o.store;return r&&(d=d.index(y.shift())),(await Promise.all([d[n](...y),i&&o.done]))[0]};return I.set(e,s),s}_(t=>({...t,get:(e,n,r)=>$(e,n)||t.get(e,n,r),has:(e,n)=>!!$(e,n)||t.has(e,n)}));const ae=["continue","continuePrimaryKey","advance"],V={},A=new WeakMap,q=new WeakMap,oe={get(t,e){if(!ae.includes(e))return t[e];let n=V[e];return n||(n=V[e]=function(...r){A.set(this,q.get(this)[e](...r))}),n}};async function*ce(...t){let e=this;if(e instanceof IDBCursor||(e=await e.openCursor(...t)),!e)return;e=e;const n=new Proxy(e,oe);for(q.set(n,e),B.set(n,x(e));e;)yield n,e=await(A.get(n)||e.continue()),A.delete(n)}function F(t,e){return e===Symbol.asyncIterator&&C(t,[IDBIndex,IDBObjectStore,IDBCursor])||e==="iterate"&&C(t,[IDBIndex,IDBObjectStore])}_(t=>({...t,get(e,n,r){return F(e,n)?ce:t.get(e,n,r)},has(e,n){return F(e,n)||t.has(e,n)}}));const le="story-db",de=1,m="saved-stories",b=re(le,de,{upgrade(t){t.objectStoreNames.contains(m)||t.createObjectStore(m,{keyPath:"id"})}}),p={async save(t){await(await b).put(m,t)},async delete(t){await(await b).delete(m,t)},async get(t){return(await b).get(m,t)},async getAll(){return(await b).getAll(m)}};class ue{constructor(e){this.view=e}async init(){this.view.init();try{const e=await G();this.view.renderStories(e),this.view.renderMap(e),this.setupBookmarkButtons(e)}catch(e){this.view.showError(e)}}setupBookmarkButtons(e){e.forEach(async n=>{const r=document.getElementById(`story-${n.id}`);if(!r)return;const i=r.querySelector(".bookmark-btn"),s=await p.get(n.id);i.innerHTML=s?"Hapus":"Simpan",i.addEventListener("click",async()=>{await p.get(n.id)?(await p.delete(n.id),i.innerHTML="Simpan"):(await p.save(n),i.innerHTML="Hapus")})})}}class me{constructor(){this.view=new W,this.presenter=new ue(this.view)}async render(){return this.view.getTemplate()}async afterRender(){await this.presenter.init()}}const P={render(){return`
      <section class="login-regist-container">
        <h1>Login Page</h1>
        <form id="login-form">
          <label for="email">Email</label>
          <input type="email" id="email" placeholder="Email" required />
          <label for="password" class="label-password-login">Password</label>
          <input type="password" id="password" placeholder="Password" required />
          <br/>
          <button type="submit">Login</button>
        </form>
        <p>Belum punya akun? <a href="#/register">Daftar di sini</a></p>
      </section>
    `},bindLoginHandler(t){document.getElementById("login-form").addEventListener("submit",async n=>{n.preventDefault();const r=document.getElementById("email").value,i=document.getElementById("password").value;t(r,i)})},showError(t){alert(`Error: ${t}`)},showSuccess(){alert("Login berhasil!"),window.location.hash="#/"}},pe={async handleLogin(t,e,n){try{await z(t,e),n.showSuccess()}catch(r){n.showError(r.message)}}};class he{async render(){return P.render()}async afterRender(){P.bindLoginHandler((e,n)=>{pe.handleLogin(e,n,P)})}}const D={render(){return`
      <section class="login-regist-container">
        <h1>Register</h1>
        <form id="regist-form">
          <label for="name">Nama</label> 
          <input type="text" name="name" placeholder="Name" required /><br />
          <label for="email">Email</label>
          <input type="email" name="email" placeholder="Email" required /><br />
          <label for="password">Password</label>
          <input type="password" name="password" placeholder="Password" required /><br />
          <button type="submit">Register</button>
        </form>
        <p id="registerMessage"></p>
      </section>
    `},bindRegisterHandler(t){const e=document.getElementById("regist-form");e.addEventListener("submit",async n=>{n.preventDefault();const r=e.name.value,i=e.email.value,s=e.password.value;t(r,i,s)})},showMessage(t){document.getElementById("registerMessage").innerText=t},navigateToLogin(){window.location.hash="#/login"}},ge={async handleRegister(t,e,n,r){try{const i=await J(t,e,n);r.showMessage(i.message),r.navigateToLogin()}catch(i){r.showMessage(i.message)}}};class ye{async render(){return D.render()}async afterRender(){D.bindRegisterHandler((e,n,r)=>{ge.handleRegister(e,n,r,D)})}}class N{constructor(){this.form=null,this.description=null,this.photoInput=null,this.lat=null,this.lon=null,this.map=null,this.marker=null,this.useCameraBtn=null,this.video=null,this.canvas=null,this.captureBtn=null,this.imageBlob=null,this.stream=null}getTemplate(){return`
      <section class="add-container">
        <h1>Tambah Cerita Baru</h1>
        <form id="add-story-form">
          <textarea id="description" placeholder="Deskripsi cerita" required></textarea><br/>
          <div class="button-group">
            <button type="button" id="use-camera-btn">Ambil dari Kamera</button>
            <input type="file" id="photo" accept="image/*" /><br/>
          </div>
          <div id="camera-container" style="display:none; margin-top:10px;">
            <video id="video" autoplay playsinline style="max-width:100%; height:auto;"></video><br/>
            <button type="button" id="capture-btn">Ambil Gambar</button>
          </div>
          <canvas id="canvas" style="display:none;"></canvas>

          <label for="lat">Latitude</label>
          <input type="number" id="lat" step="any" placeholder="Klik peta untuk ambil lokasi" readonly required /><br/>
          <label for="lon">Longitude</label>
          <input type="number" id="lon" step="any" placeholder="Klik peta untuk ambil lokasi" readonly required /><br/>
          <div id="map" style="height: 300px; margin: 10px 0;"></div>

          <button type="submit">Kirim Cerita</button>
        </form>
      </section>
    `}initElements(){this.form=document.getElementById("add-story-form"),this.description=document.getElementById("description"),this.photoInput=document.getElementById("photo"),this.lat=document.getElementById("lat"),this.lon=document.getElementById("lon"),this.useCameraBtn=document.getElementById("use-camera-btn"),this.video=document.getElementById("video"),this.canvas=document.getElementById("canvas"),this.captureBtn=document.getElementById("capture-btn"),this.initMap(),this.initCamera()}initMap(){this.map=L.map("map").setView([-2.5,117.5],4),L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{attribution:"Â© OpenStreetMap contributors"}).addTo(this.map),this.map.on("click",e=>{const{lat:n,lng:r}=e.latlng;this.lat.value=n.toFixed(6),this.lon.value=r.toFixed(6),this.marker&&this.map.removeLayer(this.marker),this.marker=L.marker([n,r]).addTo(this.map).bindPopup("Lokasi dipilih").openPopup()})}initCamera(){const e=document.getElementById("camera-container");this.useCameraBtn.addEventListener("click",async()=>{this.photoInput.value="",this.imageBlob=null,e.style.display="block";try{this.stream=await navigator.mediaDevices.getUserMedia({video:{facingMode:"environment"}}),this.video.srcObject=this.stream}catch(n){alert("Tidak dapat mengakses kamera: "+n.message)}}),this.captureBtn.addEventListener("click",()=>{const n=this.canvas.getContext("2d");this.canvas.width=this.video.videoWidth,this.canvas.height=this.video.videoHeight,n.drawImage(this.video,0,0,this.canvas.width,this.canvas.height),this.canvas.toBlob(r=>{this.imageBlob=r,alert("Gambar berhasil diambil dari kamera!"),this.stopCamera()},"image/jpeg")})}stopCamera(){this.stream&&(this.stream.getTracks().forEach(e=>e.stop()),this.stream=null,document.getElementById("camera-container").style.display="none")}onSubmit(e){this.form.addEventListener("submit",n=>{n.preventDefault();let r=null;if(this.imageBlob)r=new File([this.imageBlob],"photo.jpg",{type:"image/jpeg"});else if(this.photoInput.files[0])r=this.photoInput.files[0];else{alert("Silakan ambil gambar dari kamera atau pilih dari galeri.");return}const i={description:this.description.value,photo:r,lat:parseFloat(this.lat.value),lon:parseFloat(this.lon.value)};e(i)})}}class fe{constructor(e){this.view=e}async handleFormSubmit(e){try{await Y(e),alert("Cerita berhasil dikirim!"),window.location.hash="#/"}catch(n){alert("Gagal mengirim cerita: "+n.message)}}bindEvents(){this.view.onSubmit(this.handleFormSubmit.bind(this))}}class we{async render(){return new N().getTemplate()}async afterRender(){const e=new N;e.initElements(),new fe(e).bindEvents()}}class be{constructor(){this.listContainer=null,this.mapContainer=null}getTemplate(){return`
      <section class="saved-container">
        <h1>Daftar Cerita Tersimpan</h1>
        <div id="saved-story-list" class="story-list"></div>
      </section>
    `}init(){this.listContainer=document.getElementById("saved-story-list"),this.mapContainer=document.getElementById("map")}renderSavedStories(e){this.listContainer.innerHTML=e.map(n=>`
      <div id="saved-${n.id}" class="story-card" style="border: 1px solid #ccc; padding: 10px; margin: 10px 0;">
        <img src="${n.photoUrl}" alt="${n.name}" width="200" />
        <p><strong>${n.name}</strong></p>
        <p>${n.description}</p>
        <p>${new Date(n.createdAt).toLocaleString()}</p>
        <button class="remove-btn">Hapus</button>
      </div>
    `).join("")}bindDeleteHandlers(e){document.querySelectorAll(".remove-btn").forEach(n=>{n.addEventListener("click",()=>{const r=n.parentElement.id.replace("saved-","");e(r)})})}showEmptyMessage(){this.listContainer.innerHTML="<p>Tidak ada cerita tersimpan.</p>"}}class ve{constructor(e){this.view=e}async init(){this.view.init();const e=await p.getAll();e.length?(this.view.renderSavedStories(e),this.view.bindDeleteHandlers(async n=>{await p.delete(n),this.init()})):this.view.showEmptyMessage()}}class Ee{constructor(){this.view=new be,this.presenter=new ve(this.view)}async render(){return this.view.getTemplate()}async afterRender(){await this.presenter.init()}}class Be{async render(){return`
      <section class="not-found" style="text-align: center; padding: 2rem;">
        <h2 style="font-size: 2rem; margin-bottom: 1rem;">404 - Halaman Tidak Ditemukan</h2>
        <p style="margin-bottom: 1.5rem;">Maaf, halaman yang Anda cari tidak tersedia.</p>
        <a href="#/" style="color: #007bff; text-decoration: underline;">Kembali ke Beranda</a>
      </section>
    `}async afterRender(){}}const U={"/":new me,"/login":new he,"/register":new ye,"/add":new we,"/save":new Ee,"*":new Be};function Le(t){const e=t.split("/");return{resource:e[1]||null,id:e[2]||null}}function ke(t){let e="";return t.resource&&(e=e.concat(`/${t.resource}`)),t.id&&(e=e.concat("/:id")),e||"/"}function Se(){return location.hash.replace("#","")||"/"}function Ie(){const t=Se(),e=Le(t);return ke(e)}var h,g,l,v,K;class Pe{constructor({navigationDrawer:e,drawerButton:n,content:r}){f(this,v);f(this,h,null);f(this,g,null);f(this,l,null);w(this,h,r),w(this,g,n),w(this,l,e),R(this,v,K).call(this)}async renderPage(){const e=Ie(),n=U[e]||U["*"];document.startViewTransition?document.startViewTransition(async()=>{c(this,h).innerHTML=await n.render(),await n.afterRender()}):(c(this,h).innerHTML=await n.render(),await n.afterRender())}}h=new WeakMap,g=new WeakMap,l=new WeakMap,v=new WeakSet,K=function(){c(this,g).addEventListener("click",()=>{c(this,l).classList.toggle("open")}),document.body.addEventListener("click",e=>{!c(this,l).contains(e.target)&&!c(this,g).contains(e.target)&&c(this,l).classList.remove("open"),c(this,l).querySelectorAll("a").forEach(n=>{n.contains(e.target)&&c(this,l).classList.remove("open")})})};const De="BCCs2eonMI-6H2ctvFaWg-UYdDv387Vno_bzUzALpB442r2lCnsHmtrx8biyPi_E-1fSGABK_Qs_GlvPoJJqxbk";function Ce(t){const e="=".repeat((4-t.length%4)%4),n=(t+e).replace(/-/g,"+").replace(/_/g,"/"),r=atob(n);return new Uint8Array([...r].map(i=>i.charCodeAt(0)))}async function Te(t){try{if(!t.pushManager){console.warn("Push manager tidak tersedia di browser ini.");return}const e=await t.pushManager.subscribe({userVisibleOnly:!0,applicationServerKey:Ce(De)}),n=localStorage.getItem("token");if(!n)throw new Error("Token tidak ditemukan di localStorage");const r={endpoint:e.endpoint,keys:{p256dh:e.toJSON().keys.p256dh,auth:e.toJSON().keys.auth}},s=await(await fetch("https://story-api.dicoding.dev/v1/notifications/subscribe",{method:"POST",headers:{Authorization:n,"Content-Type":"application/json"},body:JSON.stringify(r)})).json();console.log("Berhasil subscribe notifikasi:",s.message)}catch(e){console.error("Gagal menginisialisasi push notification:",e)}}function Me(){return"serviceWorker"in navigator}async function xe(){if(!Me()){console.log("Service Worker API unsupported");return}try{const t=await navigator.serviceWorker.register("/sw.js");console.log("Service worker telah terpasang",t),localStorage.getItem("token")&&await Te(t)}catch(t){console.log("Failed to install service worker:",t)}}document.addEventListener("DOMContentLoaded",async()=>{const t=new Pe({content:document.querySelector("#main-content"),drawerButton:document.querySelector("#drawer-button"),navigationDrawer:document.querySelector("#navigation-drawer")});await t.renderPage(),await xe();let e;window.addEventListener("beforeinstallprompt",n=>{n.preventDefault(),e=n;const r=document.createElement("button");r.id="install-button",r.innerText="Install Aplikasi",r.style.position="fixed",r.style.bottom="16px",r.style.right="16px",r.style.padding="8px 12px",r.style.zIndex="999",r.style.borderRadius="8px",r.style.background="#6200ee",r.style.color="white",document.body.appendChild(r),r.addEventListener("click",async()=>{r.remove(),e.prompt();const{outcome:i}=await e.userChoice;console.log(i==="accepted"?"User accepted install":"User dismissed install"),e=null})}),window.addEventListener("hashchange",async()=>{await t.renderPage()})});
